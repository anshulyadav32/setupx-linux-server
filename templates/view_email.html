{% extends "base.html" %}

{% block title %}{{ email.subject }} - SMTP Web Interface{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-envelope-open me-2 text-primary"></i>
        Email Details
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('list_emails') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Inbox
            </a>
            <button type="button" class="btn btn-outline-danger" onclick="deleteEmail('{{ email.filename }}')">
                <i class="fas fa-trash me-1"></i>
                Delete
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Email Header -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0">{{ email.subject }}</h4>
                    </div>
                    <div class="col-auto">
                        <span class="badge bg-light text-dark">
                            {{ "%.1f"|format(email.size / 1024) }} KB
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar-md bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="fas fa-user text-white fa-lg"></i>
                            </div>
                            <div>
                                <div class="fw-bold">From</div>
                                <div class="text-muted">{{ email.from }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar-md bg-success rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="fas fa-envelope text-white fa-lg"></i>
                            </div>
                            <div>
                                <div class="fw-bold">To</div>
                                <div class="text-muted">{{ email.to }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="avatar-md bg-info rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="fas fa-calendar text-white fa-lg"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Date Sent</div>
                                <div class="text-muted">{{ email.date }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="avatar-md bg-warning rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="fas fa-clock text-white fa-lg"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Received</div>
                                <div class="text-muted">{{ email.modified }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Content -->
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Message Content
                    </h5>
                    <div class="btn-group btn-group-sm">
                        {% if email.html_body %}
                        <button type="button" class="btn btn-outline-primary" id="showHtml">
                            <i class="fas fa-code me-1"></i>
                            HTML View
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-outline-secondary" id="showPlain">
                            <i class="fas fa-align-left me-1"></i>
                            Plain Text
                        </button>
                        <button type="button" class="btn btn-outline-info" id="showRaw">
                            <i class="fas fa-file-code me-1"></i>
                            Raw Source
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Plain Text View -->
                <div id="plainView" class="email-content">
                    {% if email.body %}
                        <div class="bg-light p-3 rounded">
                            <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ email.body }}</pre>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                            <p>No plain text content available</p>
                        </div>
                    {% endif %}
                </div>

                <!-- HTML View -->
                {% if email.html_body %}
                <div id="htmlView" class="email-content" style="display: none;">
                    <div class="border rounded p-3">
                        <iframe id="htmlFrame" style="width: 100%; min-height: 400px; border: none;"></iframe>
                    </div>
                </div>
                {% endif %}

                <!-- Raw Source View -->
                <div id="rawView" class="email-content" style="display: none;">
                    <div class="bg-dark text-light p-3 rounded">
                        <pre class="mb-0" style="font-size: 0.85em; white-space: pre-wrap;"><code id="rawContent">Loading raw content...</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Actions -->
        <div class="card mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="replyToEmail()">
                        <i class="fas fa-reply me-1"></i>
                        Reply
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="forwardEmail()">
                        <i class="fas fa-share me-1"></i>
                        Forward
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="downloadEmail()">
                        <i class="fas fa-download me-1"></i>
                        Download .eml
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="printEmail()">
                        <i class="fas fa-print me-1"></i>
                        Print
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteEmail('{{ email.filename }}')">
                        <i class="fas fa-trash me-1"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this email? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <strong>Email:</strong> {{ email.subject }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentView = 'plain';
    
    // View switching
    document.getElementById('showPlain').addEventListener('click', function() {
        showView('plain');
        setActiveButton(this);
    });
    
    {% if email.html_body %}
    document.getElementById('showHtml').addEventListener('click', function() {
        showView('html');
        setActiveButton(this);
        loadHtmlContent();
    });
    {% endif %}
    
    document.getElementById('showRaw').addEventListener('click', function() {
        showView('raw');
        setActiveButton(this);
        loadRawContent();
    });
    
    function showView(view) {
        document.querySelectorAll('.email-content').forEach(el => el.style.display = 'none');
        document.getElementById(view + 'View').style.display = 'block';
        currentView = view;
    }
    
    function setActiveButton(activeBtn) {
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        activeBtn.classList.add('active');
    }
    
    {% if email.html_body %}
    function loadHtmlContent() {
        const iframe = document.getElementById('htmlFrame');
        const htmlContent = `{{ email.html_body|replace('\n', '\\n')|replace('\r', '\\r')|replace('"', '\\"')|replace("'", "\\'")|safe }}`;
        iframe.srcdoc = htmlContent;
    }
    {% endif %}
    
    function loadRawContent() {
        fetch(`/api/email/{{ email.filename }}`)
            .then(response => response.json())
            .then(data => {
                // This would need to be implemented to return raw email content
                document.getElementById('rawContent').textContent = 
                    'Raw email content would be displayed here.\n' +
                    'This requires additional backend implementation to read the .eml file directly.';
            })
            .catch(error => {
                document.getElementById('rawContent').textContent = 'Error loading raw content: ' + error;
            });
    }
    
    // Email actions
    function replyToEmail() {
        const replySubject = 'Re: {{ email.subject }}';
        const replyTo = '{{ email.from }}';
        const url = `{{ url_for('compose') }}?to=${encodeURIComponent(replyTo)}&subject=${encodeURIComponent(replySubject)}`;
        window.location.href = url;
    }
    
    function forwardEmail() {
        const fwdSubject = 'Fwd: {{ email.subject }}';
        const fwdBody = `\n\n--- Forwarded Message ---\nFrom: {{ email.from }}\nTo: {{ email.to }}\nSubject: {{ email.subject }}\nDate: {{ email.date }}\n\n{{ email.body }}`;
        const url = `{{ url_for('compose') }}?subject=${encodeURIComponent(fwdSubject)}&body=${encodeURIComponent(fwdBody)}`;
        window.location.href = url;
    }
    
    function downloadEmail() {
        // Create a download link for the .eml file
        const link = document.createElement('a');
        link.href = `/api/email/{{ email.filename }}?download=true`;
        link.download = '{{ email.filename }}';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function printEmail() {
        window.print();
    }
    
    function deleteEmail(filename) {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    // Confirm delete
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_email/{{ email.filename }}`;
        document.body.appendChild(form);
        form.submit();
    });
    
    // Initialize with plain text view
    setActiveButton(document.getElementById('showPlain'));
    
    // Print styles
    const printStyles = `
        <style media="print">
            .sidebar, .btn-toolbar, .card-header .btn-group, .card:last-child { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; }
        </style>
    `;
    document.head.insertAdjacentHTML('beforeend', printStyles);
</script>
{% endblock %}