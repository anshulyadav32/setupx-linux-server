{% extends "base.html" %}

{% block title %}Domain Management - SMTP Web Interface{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-globe me-2"></i>
                    Domain Management
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Domain Management</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ domains|length }}</h4>
                            <p class="mb-0">Total Domains</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-globe fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ domains|selectattr('is_active')|list|length }}</h4>
                            <p class="mb-0">Active Domains</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ domains|selectattr('is_local')|list|length }}</h4>
                            <p class="mb-0">Local Domains</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-server fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ domains|rejectattr('is_local')|list|length }}</h4>
                            <p class="mb-0">Relay Domains</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exchange-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Domain Button -->
    <div class="row mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
                <i class="fas fa-plus me-2"></i>Add New Domain
            </button>
        </div>
    </div>

    <!-- Domains Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Domains
                    </h5>
                </div>
                <div class="card-body">
                    {% if domains %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Domain Name</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>DNS Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for domain in domains %}
                                <tr>
                                    <td>
                                        <strong>{{ domain.domain_name }}</strong>
                                    </td>
                                    <td>{{ domain.description or '-' }}</td>
                                    <td>
                                        {% if domain.is_local %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-server me-1"></i>Local
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-exchange-alt me-1"></i>Relay
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if domain.is_active %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Active
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Inactive
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dns-status-container" data-domain="{{ domain.domain_name }}">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-spinner fa-spin me-1"></i>Checking...
                                            </span>
                                            <button class="btn btn-sm btn-outline-secondary ms-1" 
                                                    onclick="refreshDnsStatus('{{ domain.domain_name }}')" 
                                                    title="Refresh DNS Status">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>{{ domain.created_at.strftime('%Y-%m-%d %H:%M') if domain.created_at else '-' }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="editDomain({{ domain.id }}, '{{ domain.domain_name }}', '{{ domain.description or '' }}', {{ domain.is_active|lower }}, {{ domain.is_local|lower }}, {{ (domain.relay_config|tojson) if domain.relay_config else 'null' }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if domain.is_active %}
                                                <form method="post" style="display: inline;">
                                                    <input type="hidden" name="action" value="deactivate">
                                                    <input type="hidden" name="domain_id" value="{{ domain.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-warning" 
                                                            onclick="return confirm('Deactivate domain {{ domain.domain_name }}?')">
                                                        <i class="fas fa-pause"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <form method="post" style="display: inline;">
                                                    <input type="hidden" name="action" value="activate">
                                                    <input type="hidden" name="domain_id" value="{{ domain.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-success" 
                                                            onclick="return confirm('Activate domain {{ domain.domain_name }}?')">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                            <form method="post" style="display: inline;">
                                                <input type="hidden" name="action" value="delete">
                                                <input type="hidden" name="domain_id" value="{{ domain.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        onclick="return confirm('Delete domain {{ domain.domain_name }}? This action cannot be undone.')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-globe fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No domains configured</h5>
                        <p class="text-muted">Add your first domain to start managing email routing.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
                            <i class="fas fa-plus me-2"></i>Add Domain
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Domain Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1" aria-labelledby="addDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDomainModalLabel">
                    <i class="fas fa-plus me-2"></i>Add New Domain
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                <div class="modal-body">
                    <input type="hidden" name="action" value="add">
                    
                    <div class="mb-3">
                        <label for="domain_name" class="form-label">Domain Name *</label>
                        <input type="text" class="form-control" id="domain_name" name="domain_name" 
                               placeholder="example.com" required>
                        <div class="form-text">Enter the domain name (e.g., example.com)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2" 
                                  placeholder="Optional description for this domain"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_local" name="is_local" checked 
                                   onchange="toggleRelayConfig(this)">
                            <label class="form-check-label" for="is_local">
                                Local Domain
                            </label>
                            <div class="form-text">Check if this domain is handled locally, uncheck for relay domains</div>
                        </div>
                    </div>
                    
                    <!-- Relay Configuration (hidden by default) -->
                    <div id="relayConfig" style="display: none;">
                        <h6 class="mb-3">Relay Configuration</h6>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="relay_host" class="form-label">Relay Host *</label>
                                    <input type="text" class="form-control" id="relay_host" name="relay_host" 
                                           placeholder="smtp.example.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="relay_port" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="relay_port" name="relay_port" 
                                           value="587" min="1" max="65535">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="relay_username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="relay_username" name="relay_username">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="relay_password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="relay_password" name="relay_password">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use_tls" name="use_tls" checked>
                                    <label class="form-check-label" for="use_tls">Use TLS</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use_ssl" name="use_ssl">
                                    <label class="form-check-label" for="use_ssl">Use SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Domain
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Domain Modal -->
<div class="modal fade" id="editDomainModal" tabindex="-1" aria-labelledby="editDomainModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDomainModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Domain
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="domain_id" id="edit_domain_id">
                    
                    <div class="mb-3">
                        <label for="edit_domain_name" class="form-label">Domain Name *</label>
                        <input type="text" class="form-control" id="edit_domain_name" name="domain_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                            <label class="form-check-label" for="edit_is_active">Active</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_local" name="is_local" 
                                   onchange="toggleEditRelayConfig(this)">
                            <label class="form-check-label" for="edit_is_local">Local Domain</label>
                        </div>
                    </div>
                    
                    <!-- Edit Relay Configuration -->
                    <div id="editRelayConfig">
                        <h6 class="mb-3">Relay Configuration</h6>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="edit_relay_host" class="form-label">Relay Host</label>
                                    <input type="text" class="form-control" id="edit_relay_host" name="relay_host">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="edit_relay_port" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="edit_relay_port" name="relay_port" 
                                           value="587" min="1" max="65535">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_relay_username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="edit_relay_username" name="relay_username">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_relay_password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="edit_relay_password" name="relay_password">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_use_tls" name="use_tls">
                                    <label class="form-check-label" for="edit_use_tls">Use TLS</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_use_ssl" name="use_ssl">
                                    <label class="form-check-label" for="edit_use_ssl">Use SSL</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleRelayConfig(checkbox) {
    const relayConfig = document.getElementById('relayConfig');
    if (checkbox.checked) {
        relayConfig.style.display = 'none';
    } else {
        relayConfig.style.display = 'block';
    }
}

function toggleEditRelayConfig(checkbox) {
    const relayConfig = document.getElementById('editRelayConfig');
    if (checkbox.checked) {
        relayConfig.style.display = 'none';
    } else {
        relayConfig.style.display = 'block';
    }
}

function editDomain(id, name, description, isActive, isLocal, relayConfig) {
    document.getElementById('edit_domain_id').value = id;
    document.getElementById('edit_domain_name').value = name;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_is_active').checked = isActive;
    document.getElementById('edit_is_local').checked = isLocal;
    
    // Handle relay configuration
    if (relayConfig && !isLocal) {
        document.getElementById('edit_relay_host').value = relayConfig.host || '';
        document.getElementById('edit_relay_port').value = relayConfig.port || 587;
        document.getElementById('edit_relay_username').value = relayConfig.username || '';
        document.getElementById('edit_relay_password').value = relayConfig.password || '';
        document.getElementById('edit_use_tls').checked = relayConfig.use_tls || false;
        document.getElementById('edit_use_ssl').checked = relayConfig.use_ssl || false;
    }
    
    toggleEditRelayConfig(document.getElementById('edit_is_local'));
    
    const modal = new bootstrap.Modal(document.getElementById('editDomainModal'));
    modal.show();
}

// DNS Status Functions
function updateDnsStatus(domain, status) {
    const container = document.querySelector(`[data-domain="${domain}"]`);
    if (!container) return;
    
    let badgeClass = 'bg-secondary';
    let icon = 'fas fa-question';
    let text = 'Unknown';
    
    switch (status.overall_status) {
        case 'healthy':
            badgeClass = 'bg-success';
            icon = 'fas fa-check';
            text = 'Healthy';
            break;
        case 'warning':
            badgeClass = 'bg-warning';
            icon = 'fas fa-exclamation-triangle';
            text = 'Warning';
            break;
        case 'error':
            badgeClass = 'bg-danger';
            icon = 'fas fa-times';
            text = 'Error';
            break;
    }
    
    const badge = container.querySelector('.badge');
    badge.className = `badge ${badgeClass}`;
    badge.innerHTML = `<i class="${icon} me-1"></i>${text}`;
    badge.title = `Last checked: ${new Date(status.timestamp).toLocaleString()}`;
    
    // Add detailed tooltip with DNS record information
    let tooltip = `DNS Status Details:\n`;
    tooltip += `A Record: ${status.checks.a_record.status} (${status.checks.a_record.value || status.checks.a_record.error})\n`;
    tooltip += `MX Record: ${status.checks.mx_record.status} (${status.checks.mx_record.value.length} records)\n`;
    tooltip += `TXT Record: ${status.checks.txt_record.status} (${status.checks.txt_record.value.length} records)\n`;
    tooltip += `NS Record: ${status.checks.ns_record.status} (${status.checks.ns_record.value.length} records)`;
    badge.title = tooltip;
}

function refreshDnsStatus(domain) {
    const container = document.querySelector(`[data-domain="${domain}"]`);
    if (!container) return;
    
    const badge = container.querySelector('.badge');
    badge.className = 'badge bg-secondary';
    badge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    
    fetch(`/api/domain/${domain}/dns-status`)
        .then(response => response.json())
        .then(data => {
            updateDnsStatus(domain, data);
        })
        .catch(error => {
            console.error('Error fetching DNS status:', error);
            badge.className = 'badge bg-danger';
            badge.innerHTML = '<i class="fas fa-times me-1"></i>Error';
            badge.title = 'Failed to check DNS status';
        });
}

// Load DNS status for all domains on page load
document.addEventListener('DOMContentLoaded', function() {
    const containers = document.querySelectorAll('.dns-status-container');
    containers.forEach(container => {
        const domain = container.getAttribute('data-domain');
        setTimeout(() => refreshDnsStatus(domain), Math.random() * 2000); // Stagger requests
    });
});
</script>
{% endblock %}