{% extends "base.html" %}

{% block title %}Compose Email - SMTP Web Interface{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-edit me-2 text-primary"></i>
        Compose Email
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('list_emails') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Inbox
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <form id="composeForm" method="POST" enctype="multipart/form-data">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-envelope me-2"></i>
                            New Message
                        </h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="saveDraft()">
                                <i class="fas fa-save me-1"></i>
                                Save Draft
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleHtmlMode()">
                                <i class="fas fa-code me-1"></i>
                                <span id="htmlToggleText">HTML Mode</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Email Headers -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="from" class="form-label">
                                <i class="fas fa-user me-1"></i>
                                From
                            </label>
                            <input type="email" class="form-control" id="from" name="from" 
                                   value="{{ request.args.get('from', 'sender@localhost') }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="to" class="form-label">
                                <i class="fas fa-envelope me-1"></i>
                                To <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="to" name="to" 
                                   value="{{ request.args.get('to', '') }}" 
                                   placeholder="recipient@example.com, another@example.com" required>
                            <div class="form-text">Separate multiple recipients with commas</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="cc" class="form-label">
                                <i class="fas fa-copy me-1"></i>
                                CC
                            </label>
                            <input type="text" class="form-control" id="cc" name="cc" 
                                   placeholder="cc@example.com">
                        </div>
                        <div class="col-md-6">
                            <label for="bcc" class="form-label">
                                <i class="fas fa-eye-slash me-1"></i>
                                BCC
                            </label>
                            <input type="text" class="form-control" id="bcc" name="bcc" 
                                   placeholder="bcc@example.com">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subject" class="form-label">
                            <i class="fas fa-tag me-1"></i>
                            Subject <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="subject" name="subject" 
                               value="{{ request.args.get('subject', '') }}" required>
                    </div>

                    <!-- Attachments -->
                    <div class="mb-3">
                        <label for="attachments" class="form-label">
                            <i class="fas fa-paperclip me-1"></i>
                            Attachments
                        </label>
                        <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                        <div class="form-text">You can select multiple files</div>
                        <div id="attachmentList" class="mt-2"></div>
                    </div>

                    <!-- Message Body -->
                    <div class="mb-3">
                        <label for="body" class="form-label">
                            <i class="fas fa-align-left me-1"></i>
                            Message <span class="text-danger">*</span>
                        </label>
                        
                        <!-- Plain Text Editor -->
                        <div id="plainEditor">
                            <textarea class="form-control" id="body" name="body" rows="12" 
                                      placeholder="Type your message here..." required>{{ request.args.get('body', '') }}</textarea>
                        </div>

                        <!-- HTML Editor -->
                        <div id="htmlEditor" style="display: none;">
                            <div class="border rounded">
                                <!-- HTML Toolbar -->
                                <div class="bg-light p-2 border-bottom">
                                    <div class="btn-group btn-group-sm me-2">
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                                            <i class="fas fa-underline"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm me-2">
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('justifyLeft')">
                                            <i class="fas fa-align-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('justifyCenter')">
                                            <i class="fas fa-align-center"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('justifyRight')">
                                            <i class="fas fa-align-right"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertLink()">
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertImage()">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- HTML Content Area -->
                                <div id="htmlContent" contenteditable="true" 
                                     style="min-height: 300px; padding: 15px; outline: none;">
                                </div>
                            </div>
                            <input type="hidden" id="htmlBody" name="html_body">
                        </div>
                    </div>

                    <!-- SMTP Settings -->
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-cog me-1"></i>
                                SMTP Settings
                                <button type="button" class="btn btn-sm btn-outline-secondary float-end" 
                                        onclick="toggleAdvanced()">
                                    <span id="advancedToggle">Show Advanced</span>
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="smtp_host" class="form-label">SMTP Host</label>
                                    <input type="text" class="form-control" id="smtp_host" name="smtp_host" 
                                           value="localhost">
                                </div>
                                <div class="col-md-2">
                                    <label for="smtp_port" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                                           value="1025" min="1" max="65535">
                                </div>
                                <div class="col-md-3">
                                    <label for="use_tls" class="form-label">Security</label>
                                    <select class="form-select" id="use_tls" name="use_tls">
                                        <option value="none">None</option>
                                        <option value="tls">TLS</option>
                                        <option value="ssl">SSL</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="timeout" class="form-label">Timeout (s)</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout" 
                                           value="30" min="5" max="300">
                                </div>
                            </div>
                            
                            <div id="advancedSettings" style="display: none;">
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" name="username">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="password" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="password" name="password">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="fas fa-times me-1"></i>
                                Clear
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="previewEmail()">
                                <i class="fas fa-eye me-1"></i>
                                Preview
                            </button>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary" id="sendBtn">
                                <i class="fas fa-paper-plane me-1"></i>
                                Send Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="sendFromPreview()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Sending email...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isHtmlMode = false;
    let advancedVisible = false;
    
    // Form submission
    document.getElementById('composeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEmail();
    });
    
    // File attachment handling
    document.getElementById('attachments').addEventListener('change', function(e) {
        updateAttachmentList();
    });
    
    function updateAttachmentList() {
        const files = document.getElementById('attachments').files;
        const listDiv = document.getElementById('attachmentList');
        
        if (files.length === 0) {
            listDiv.innerHTML = '';
            return;
        }
        
        let html = '<div class="mt-2"><strong>Selected files:</strong><ul class="list-unstyled mt-1">';
        for (let i = 0; i < files.length; i++) {
            const size = (files[i].size / 1024).toFixed(1);
            html += `<li><i class="fas fa-file me-1"></i>${files[i].name} (${size} KB)</li>`;
        }
        html += '</ul></div>';
        listDiv.innerHTML = html;
    }
    
    // HTML/Plain text mode toggle
    function toggleHtmlMode() {
        isHtmlMode = !isHtmlMode;
        const plainEditor = document.getElementById('plainEditor');
        const htmlEditor = document.getElementById('htmlEditor');
        const toggleText = document.getElementById('htmlToggleText');
        
        if (isHtmlMode) {
            plainEditor.style.display = 'none';
            htmlEditor.style.display = 'block';
            toggleText.textContent = 'Plain Text';
            
            // Copy plain text to HTML editor
            const plainText = document.getElementById('body').value;
            document.getElementById('htmlContent').innerHTML = plainText.replace(/\n/g, '<br>');
        } else {
            plainEditor.style.display = 'block';
            htmlEditor.style.display = 'none';
            toggleText.textContent = 'HTML Mode';
            
            // Copy HTML to plain text (strip tags)
            const htmlContent = document.getElementById('htmlContent').innerHTML;
            document.getElementById('body').value = htmlContent.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
        }
    }
    
    // HTML formatting functions
    function formatText(command) {
        document.execCommand(command, false, null);
        document.getElementById('htmlContent').focus();
    }
    
    function insertLink() {
        const url = prompt('Enter URL:');
        if (url) {
            document.execCommand('createLink', false, url);
        }
    }
    
    function insertImage() {
        const url = prompt('Enter image URL:');
        if (url) {
            document.execCommand('insertImage', false, url);
        }
    }
    
    // Advanced settings toggle
    function toggleAdvanced() {
        advancedVisible = !advancedVisible;
        const settings = document.getElementById('advancedSettings');
        const toggle = document.getElementById('advancedToggle');
        
        if (advancedVisible) {
            settings.style.display = 'block';
            toggle.textContent = 'Hide Advanced';
        } else {
            settings.style.display = 'none';
            toggle.textContent = 'Show Advanced';
        }
    }
    
    // Form actions
    function clearForm() {
        if (confirm('Are you sure you want to clear the form? All unsaved changes will be lost.')) {
            document.getElementById('composeForm').reset();
            document.getElementById('attachmentList').innerHTML = '';
            if (isHtmlMode) {
                document.getElementById('htmlContent').innerHTML = '';
            }
        }
    }
    
    function saveDraft() {
        // This would save the email as a draft
        alert('Draft saving functionality would be implemented here.');
    }
    
    function previewEmail() {
        const formData = new FormData(document.getElementById('composeForm'));
        
        // Update HTML body if in HTML mode
        if (isHtmlMode) {
            formData.set('html_body', document.getElementById('htmlContent').innerHTML);
        }
        
        // Create preview content
        let previewHtml = `
            <div class="email-preview">
                <div class="mb-3">
                    <strong>From:</strong> ${formData.get('from')}<br>
                    <strong>To:</strong> ${formData.get('to')}<br>
                    ${formData.get('cc') ? `<strong>CC:</strong> ${formData.get('cc')}<br>` : ''}
                    ${formData.get('bcc') ? `<strong>BCC:</strong> ${formData.get('bcc')}<br>` : ''}
                    <strong>Subject:</strong> ${formData.get('subject')}
                </div>
                <hr>
                <div class="email-body">
        `;
        
        if (isHtmlMode) {
            previewHtml += document.getElementById('htmlContent').innerHTML;
        } else {
            previewHtml += `<pre style="white-space: pre-wrap; font-family: inherit;">${formData.get('body')}</pre>`;
        }
        
        previewHtml += '</div></div>';
        
        document.getElementById('previewContent').innerHTML = previewHtml;
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
    }
    
    function sendFromPreview() {
        const previewModal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
        previewModal.hide();
        sendEmail();
    }
    
    function sendEmail() {
        const form = document.getElementById('composeForm');
        const formData = new FormData(form);
        
        // Update HTML body if in HTML mode
        if (isHtmlMode) {
            formData.set('html_body', document.getElementById('htmlContent').innerHTML);
        }
        
        // Show loading modal
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Disable send button
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        
        fetch('/send_email', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            
            if (data.success) {
                alert('Email sent successfully!');
                // Optionally redirect to inbox
                window.location.href = '/emails';
            } else {
                alert('Error sending email: ' + data.error);
            }
        })
        .catch(error => {
            loadingModal.hide();
            alert('Error sending email: ' + error);
        })
        .finally(() => {
            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Email';
        });
    }
    
    // Auto-save functionality (optional)
    let autoSaveTimer;
    function startAutoSave() {
        autoSaveTimer = setInterval(() => {
            // Auto-save logic would go here
            console.log('Auto-saving draft...');
        }, 30000); // Save every 30 seconds
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Focus on the 'to' field if it's empty
        const toField = document.getElementById('to');
        if (!toField.value) {
            toField.focus();
        }
        
        // Start auto-save
        // startAutoSave();
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (autoSaveTimer) {
            clearInterval(autoSaveTimer);
        }
    });
</script>
{% endblock %}