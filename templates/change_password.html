{% extends "base.html" %}

{% block title %}Change Password - SMTP Web Interface{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-key me-2"></i>
                    Change Password
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('profile') }}">Profile</a></li>
                        <li class="breadcrumb-item active">Change Password</li>
                    </ol>
                </nav>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Settings
                    </h5>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Security Notice -->
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Security Notice:</strong> Choose a strong password that you haven't used elsewhere. 
                        Your password will be securely encrypted and stored.
                    </div>

                    <form method="POST" action="{{ url_for('change_password') }}" id="passwordForm">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>Current Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="current_password" 
                                       name="current_password" placeholder="Enter your current password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleCurrent">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Please enter your current password.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="fas fa-key me-1"></i>New Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="new_password" 
                                       name="new_password" placeholder="Enter your new password" 
                                       required minlength="6">
                                <button class="btn btn-outline-secondary" type="button" id="toggleNew">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Password must be at least 6 characters long.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-check-double me-1"></i>Confirm New Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirm_password" 
                                       name="confirm_password" placeholder="Confirm your new password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirm">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Passwords do not match.
                            </div>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="mb-3">
                            <label class="form-label">Password Strength</label>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" id="strengthBar" role="progressbar" 
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="form-text" id="strengthText">Enter a password to see strength</small>
                        </div>

                        <!-- Password Requirements -->
                        <div class="card bg-light mb-3">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-2">
                                    <i class="fas fa-list-check me-1"></i>Password Requirements
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="requirement" id="req-length">
                                            <i class="fas fa-times text-danger"></i> At least 6 characters
                                        </div>
                                        <div class="requirement" id="req-match">
                                            <i class="fas fa-times text-danger"></i> Passwords match
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="requirement" id="req-different">
                                            <i class="fas fa-times text-danger"></i> Different from current
                                        </div>
                                        <div class="requirement" id="req-strength">
                                            <i class="fas fa-times text-danger"></i> Good strength
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning" id="submitBtn" disabled>
                                <i class="fas fa-key me-2"></i>
                                Change Password
                            </button>
                            <a href="{{ url_for('profile') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Profile
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Security Tips
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Use a unique password that you don't use elsewhere
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Include a mix of uppercase, lowercase, numbers, and symbols
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Avoid using personal information like names or birthdays
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Consider using a password manager for better security
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Password visibility toggles
    function setupPasswordToggle(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const icon = button.querySelector('i');
        
        button.addEventListener('click', function() {
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
    }
    
    setupPasswordToggle('current_password', 'toggleCurrent');
    setupPasswordToggle('new_password', 'toggleNew');
    setupPasswordToggle('confirm_password', 'toggleConfirm');
    
    // Form elements
    const form = document.getElementById('passwordForm');
    const currentPassword = document.getElementById('current_password');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submitBtn');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    
    // Requirement elements
    const reqLength = document.getElementById('req-length');
    const reqMatch = document.getElementById('req-match');
    const reqDifferent = document.getElementById('req-different');
    const reqStrength = document.getElementById('req-strength');
    
    function updateRequirement(element, valid) {
        const icon = element.querySelector('i');
        if (valid) {
            icon.className = 'fas fa-check text-success';
            element.style.color = '#198754';
        } else {
            icon.className = 'fas fa-times text-danger';
            element.style.color = '#dc3545';
        }
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        if (password.length >= 6) score += 20;
        if (password.length >= 8) score += 10;
        if (password.length >= 12) score += 10;
        
        if (/[a-z]/.test(password)) score += 10;
        if (/[A-Z]/.test(password)) score += 10;
        if (/[0-9]/.test(password)) score += 10;
        if (/[^A-Za-z0-9]/.test(password)) score += 20;
        
        if (/(.)\1{2,}/.test(password)) score -= 10; // Repeated characters
        
        let strength = 'Very Weak';
        let color = 'bg-danger';
        
        if (score >= 80) {
            strength = 'Very Strong';
            color = 'bg-success';
        } else if (score >= 60) {
            strength = 'Strong';
            color = 'bg-info';
        } else if (score >= 40) {
            strength = 'Medium';
            color = 'bg-warning';
        } else if (score >= 20) {
            strength = 'Weak';
            color = 'bg-warning';
        }
        
        return { score: Math.min(score, 100), strength, color };
    }
    
    function validateForm() {
        const currentValid = currentPassword.value.length > 0;
        const lengthValid = newPassword.value.length >= 6;
        const matchValid = newPassword.value === confirmPassword.value && confirmPassword.value.length > 0;
        const differentValid = newPassword.value !== currentPassword.value && newPassword.value.length > 0;
        
        const strength = calculatePasswordStrength(newPassword.value);
        const strengthValid = strength.score >= 40;
        
        // Update visual feedback
        currentPassword.classList.toggle('is-valid', currentValid);
        currentPassword.classList.toggle('is-invalid', !currentValid && currentPassword.value.length > 0);
        
        newPassword.classList.toggle('is-valid', lengthValid && strengthValid);
        newPassword.classList.toggle('is-invalid', (!lengthValid || !strengthValid) && newPassword.value.length > 0);
        
        confirmPassword.classList.toggle('is-valid', matchValid);
        confirmPassword.classList.toggle('is-invalid', !matchValid && confirmPassword.value.length > 0);
        
        // Update requirements
        updateRequirement(reqLength, lengthValid);
        updateRequirement(reqMatch, matchValid);
        updateRequirement(reqDifferent, differentValid);
        updateRequirement(reqStrength, strengthValid);
        
        // Update strength bar
        strengthBar.style.width = strength.score + '%';
        strengthBar.className = `progress-bar ${strength.color}`;
        strengthText.textContent = newPassword.value ? strength.strength : 'Enter a password to see strength';
        
        // Enable/disable submit button
        const allValid = currentValid && lengthValid && matchValid && differentValid && strengthValid;
        submitBtn.disabled = !allValid;
        
        return allValid;
    }
    
    // Add event listeners
    [currentPassword, newPassword, confirmPassword].forEach(input => {
        input.addEventListener('input', validateForm);
        input.addEventListener('blur', validateForm);
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            e.stopPropagation();
        }
    });
    
    // Auto-dismiss alerts
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
    
    // Focus on current password field
    currentPassword.focus();
</script>
{% endblock %}